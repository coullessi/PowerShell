# Azure Arc Diagnostics Script Documentation

## Overview

The `Get-AzureArcDiagnostic` function is a comprehensive diagnostic tool for Azure Arc Connected Machine Agent troubleshooting and analysis. This PowerShell function systematically executes diagnostic commands to assess agent health, configuration, and operational status.

## Script Features

### üîç **Comprehensive Diagnostics**
- **Agent Status Analysis**: Retrieves complete agent configuration and connection state
- **Connectivity Validation**: Tests network reachability and authentication
- **Complete Log Collection**: Generates comprehensive diagnostic archives

### üìä **Professional Reporting**
- **Timestamped Logs**: Detailed diagnostic reports with execution timestamps
- **Recommendations**: Automated troubleshooting guidance and remediation steps
- **Support-Ready**: Professional reports suitable for Microsoft Support cases

### üéØ **User-Friendly Interface**
- **Interactive Prompts**: Guided folder selection with multiple path format support
- **Progress Tracking**: Real-time status updates and progress indicators
- **Color-Coded Output**: Professional console interface with status visualization

### ‚ö° **Enterprise Features**
- **Flexible Parameters**: Support for automated and interactive modes
- **Error Handling**: Comprehensive error validation and recovery
- **Security Conscious**: Warns about sensitive information in diagnostic logs

## Workflow and Commands

The script executes the following commands in sequence:

| Command | Description | Purpose |
|---------|-------------|---------|
| `azcmagent show` | Displays current agent configuration, connection status, and metadata | Validates agent installation and registration state |
| `azcmagent check` | Performs comprehensive connectivity tests and health validation | Tests network connectivity and authentication to Azure endpoints |
| `azcmagent logs --full` | Generates complete diagnostic log archive with all available data | Creates comprehensive support package for troubleshooting |

## Usage Examples

### Interactive Mode (Default)
```powershell
Get-AzureArcDiagnostic
```
- Prompts user for log directory selection
- Uses current directory as default
- Displays comprehensive progress and status information

### Automated Mode with Custom Path
```powershell
Get-AzureArcDiagnostic -LogPath "C:\AzureArcDiagnostics" -Force
```
- Specifies custom directory for diagnostic output
- Skips interactive prompts
- Creates directory if it doesn't exist

### Quiet Mode for Scripting
```powershell
Get-AzureArcDiagnostic -LogPath ".\Logs" -Quiet
```
- Suppresses detailed output
- Suitable for automation scenarios
- Returns boolean success/failure status

### Flexible Path Formats
The script supports various path formats:
- **Relative paths**: `.\AzureArcLog`, `..\Diagnostics`
- **Absolute paths**: `C:\AzureArcLog`, `D:\Temp\Diagnostics`
- **Quoted paths**: `"C:\Azure Arc Logs"`, `'C:\Program Files\Logs'`

## Output Files

The function generates two primary outputs:

### 1. Diagnostic Log File
- **Filename**: `AzureArc_Diagnostic_[Timestamp].log`
- **Content**: Detailed execution results, command outputs, and recommendations
- **Format**: UTF-8 text file with structured sections

### 2. Azure Arc Log Archive
- **Filename**: Generated by `azcmagent logs --full` command
- **Content**: Complete Azure Arc agent diagnostic data
- **Format**: ZIP archive containing logs, configuration files, and system information

## Integration with Module Menu

The diagnostic function is fully integrated into the module's interactive menu system:

### Menu Option [3]: Azure Arc Diagnostics
- **Professional interface** with ASCII art headers
- **Detailed workflow explanation** with command table
- **Disclaimer and security warnings**
- **Confirmation prompts** for user consent
- **Status reporting** with success/failure indicators

### Help System Integration
- **Comprehensive help documentation** available through menu option [H]
- **Syntax examples** and parameter descriptions
- **Use case scenarios** and best practices

## Requirements

### System Requirements
- **Administrative privileges** (recommended for complete diagnostics)
- **Azure Connected Machine Agent** installed and accessible
- **PowerShell 5.1** or later
- **Sufficient disk space** (minimum 100MB recommended)

### Network Requirements
- **Internet connectivity** to Azure Arc endpoints
- **Firewall access** for diagnostic connectivity tests
- **DNS resolution** for Azure domains

## Security Considerations

### Data Sensitivity
- **Diagnostic logs may contain sensitive system information**
- **Review log contents before sharing with external parties**
- **Store diagnostic files in secure locations with appropriate access controls**

### Best Practices
- **Use secure file transfer methods** when sharing with Microsoft Support
- **Apply appropriate file permissions** to diagnostic directories
- **Consider data retention policies** for diagnostic archives

## Troubleshooting

### Common Issues and Solutions

#### Azure Arc Agent Not Found
- **Cause**: azcmagent not in system PATH
- **Solution**: Verify Azure Arc agent installation
- **Download**: https://aka.ms/AzureConnectedMachineAgent

#### Permission Denied Errors
- **Cause**: Insufficient permissions for log directory
- **Solution**: Run PowerShell as Administrator or choose different directory

#### Connectivity Test Failures
- **Cause**: Network connectivity issues
- **Solution**: Check firewall settings and proxy configuration

#### Log Collection Failures
- **Cause**: Insufficient disk space or agent service issues
- **Solution**: Ensure adequate disk space and agent service is running

## Support and Documentation

### Microsoft Documentation
- **Azure Arc troubleshooting**: https://docs.microsoft.com/en-us/azure/azure-arc/servers/troubleshoot-agent-onboard
- **Agent installation guide**: https://docs.microsoft.com/en-us/azure/azure-arc/servers/agent-overview
- **Network requirements**: https://docs.microsoft.com/en-us/azure/azure-arc/servers/network-requirements

### Module Information
- **Author**: Lessi Coulibaly
- **Organization**: Less-IT (AI and CyberSecurity)
- **Website**: https://lessit.net
- **Module**: DefenderEndpointDeployment v1.2.0

## Version History

### Version 1.2.0 (Current)
- ‚úÖ Added comprehensive Azure Arc diagnostics functionality
- ‚úÖ Integrated with interactive menu system
- ‚úÖ Professional diagnostic reporting with recommendations
- ‚úÖ Support for multiple path formats and automation scenarios
